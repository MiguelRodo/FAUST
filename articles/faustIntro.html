<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Intro to FAUST R package • faust</title>
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script><!-- Bootstrap --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/css/bootstrap.min.css" integrity="sha256-bZLfwXAP04zRMK2BjiO8iu9pf4FbLqX6zitd+tIvLhE=" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha256-nuL8/2cJ5NDSSwnKD8VqreErSWHtnEP9E7AySL+1ev4=" crossorigin="anonymous"></script><!-- bootstrap-toc --><link rel="stylesheet" href="../bootstrap-toc.css">
<script src="../bootstrap-toc.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><meta property="og:title" content="Intro to FAUST R package">
<meta property="og:description" content="faust">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body data-spy="scroll" data-target="#toc">
    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">faust</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="Released version">0.5.0</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../index.html">
    <span class="fas fa fas fa-home fa-lg"></span>
     
  </a>
</li>
<li>
  <a href="../reference/index.html">Reference</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    Articles
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../articles/faustIntro.html">Intro to FAUST R package</a>
    </li>
  </ul>
</li>
<li>
  <a href="../news/index.html">Changelog</a>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right">
<li>
  <a href="https://github.com/FredHutch/faust/">
    <span class="fab fa fab fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      

      </header><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1 data-toc-skip>Intro to FAUST R package</h1>
                        <h4 class="author">Evan Greene</h4>
            
            <h4 class="date">2020-07-20</h4>
      
      <small class="dont-index">Source: <a href="https://github.com/FredHutch/faust/blob/master/vignettes/faustIntro.Rmd"><code>vignettes/faustIntro.Rmd</code></a></small>
      <div class="hidden name"><code>faustIntro.Rmd</code></div>

    </div>

    
    
<div id="faust-overview" class="section level1">
<h1 class="hasAnchor">
<a href="#faust-overview" class="anchor"></a>FAUST Overview</h1>
<p>Full Annotation Using Shape-constrained Trees (FAUST) is a new method for automated discovery and annotation of single-cell data from flow and mass cytometry experiments.</p>
<p>The principal output of the pipeline is an <strong>annotated count matrix</strong>.</p>
<ul>
<li>
<strong>Rows</strong> in the count matrix correspond to <strong>samples</strong> collected in the single cell experiment.</li>
<li>The <strong>columns</strong> in the count matrix are <strong>cell populations</strong> discovered by the pipeline.</li>
<li>The <strong>columns</strong> are <em>annotated</em> by a selected subset of <em>markers</em> used in conducting the experiment.</li>
<li>The <strong>column annotations</strong> define, in terms of these <em>markers</em>, the <strong>phenotypes</strong> of all <strong>cell populations</strong> discovered by the pipeline.</li>
<li>
<strong>Entries</strong> in the count matrix correspond the <strong>number of cells</strong> in a sample that belong to a discovered cell population.</li>
</ul>
<p>This vigette provides an overview of how to use the implementation provided in the <code>FAUST</code> package.</p>
</div>
<div id="installation" class="section level1">
<h1 class="hasAnchor">
<a href="#installation" class="anchor"></a>Installation</h1>
<p>The <code>FAUST</code> package is available on the <a href="http://www.github.com/RGLab/FAUST">RGLab GitHub</a> repository. It will be made available on <a href="http://www.bioconductor.org">Bioconductor</a> in the future.</p>
<p>In order to run the code in this vignette, you will need to install some dependencies. <code>flowWorkspaceData</code> has some examples from the <a href="https://www.ncbi.nlm.nih.gov/pmc/articles/PMC4748244/">Lyoplate data set</a>. <code>flowWorkspace</code> is used to construct the <code>GatingSet</code> objects.</p>
<div class="sourceCode" id="cb1"><html><body><pre class="r"><span class="co"># flowWorkspaceData has the Lyoplate data.</span>
<span class="co"># openCyto is used to construct gating sets.</span>
<span class="co"># Run the following to install the Bioconductor dependencies.</span>
<span class="fu"><a href="https://rdrr.io/r/base/conditions.html">tryCatch</a></span>(<span class="fu"><a href="https://rdrr.io/r/utils/installed.packages.html">installed.packages</a></span>()[<span class="st">"BiocManager"</span>,<span class="st">"Version"</span>],
         <span class="kw">error</span> <span class="kw">=</span> <span class="kw">function</span>(<span class="no">e</span>){
           <span class="fu"><a href="https://rdrr.io/r/utils/install.packages.html">install.packages</a></span>(<span class="st">"BiocManager"</span>)
         })
<span class="fu"><a href="https://rdrr.io/r/base/library.html">library</a></span>(<span class="no">BiocManager</span>)
<span class="kw pkg">BiocManager</span><span class="kw ns">::</span><span class="fu"><a href="https://rdrr.io/pkg/BiocManager/man/install.html">install</a></span>(<span class="st">"flowWorkspaceData"</span>, <span class="kw">update</span> <span class="kw">=</span> <span class="fl">FALSE</span>)
<span class="kw pkg">BiocManager</span><span class="kw ns">::</span><span class="fu"><a href="https://rdrr.io/pkg/BiocManager/man/install.html">install</a></span>(<span class="st">"flowWorkspace"</span>, <span class="kw">update</span> <span class="kw">=</span> <span class="fl">FALSE</span>)</pre></body></html></div>
<p>Now we install <code>FAUST</code> and its dependency, <code>scamp</code> from the RGLab GitHub repo.</p>
<div class="sourceCode" id="cb2"><html><body><pre class="r"><span class="kw pkg">devtools</span><span class="kw ns">::</span><span class="fu"><a href="https://devtools.r-lib.org//reference/remote-reexports.html">install_github</a></span>(<span class="st">"RGLab/scamp"</span>)
<span class="kw pkg">devtools</span><span class="kw ns">::</span><span class="fu"><a href="https://devtools.r-lib.org//reference/remote-reexports.html">install_github</a></span>(<span class="st">"RGLab/FAUST"</span>)</pre></body></html></div>
</div>
<div id="an-example-workflow-" class="section level1">
<h1 class="hasAnchor">
<a href="#an-example-workflow-" class="anchor"></a>An example workflow.</h1>
<p>We load all the required libraries.</p>
<div class="sourceCode" id="cb3"><html><body><pre class="r"><span class="co"># load needed libraries.</span>
<span class="fu"><a href="https://rdrr.io/r/base/message.html">suppressPackageStartupMessages</a></span>({
  <span class="fu"><a href="https://rdrr.io/r/base/library.html">library</a></span>(<span class="no">flowWorkspaceData</span>)
  <span class="fu"><a href="https://rdrr.io/r/base/library.html">library</a></span>(<span class="no">flowWorkspace</span>)
  <span class="fu"><a href="https://rdrr.io/r/base/library.html">library</a></span>(<span class="no">ggdendro</span>)
  <span class="fu"><a href="https://rdrr.io/r/base/library.html">library</a></span>(<span class="no">scamp</span>)
  <span class="fu"><a href="https://rdrr.io/r/base/library.html">library</a></span>(<span class="no">ggplot2</span>)
  <span class="fu"><a href="https://rdrr.io/r/base/library.html">library</a></span>(<span class="no">cowplot</span>)
  <span class="fu"><a href="https://rdrr.io/r/base/library.html">library</a></span>(<span class="no">knitr</span>)
  <span class="fu"><a href="https://rdrr.io/r/base/library.html">library</a></span>(<span class="no">dplyr</span>)
  <span class="fu"><a href="https://rdrr.io/r/base/library.html">library</a></span>(<span class="no">tidyr</span>)
  <span class="fu"><a href="https://rdrr.io/r/base/library.html">library</a></span>(<span class="no">faust</span>)
})</pre></body></html></div>
<div id="using-the-faust-function-in-r" class="section level2">
<h2 class="hasAnchor">
<a href="#using-the-faust-function-in-r" class="anchor"></a>Using the <strong><span style="color:skyblue">faust</span></strong> function in <strong>R</strong>
</h2>
<p>After installing and loading the <code>FAUST</code> library, the <code>R</code> function <code style="color:skyblue">faust</code> is available to analyze data.</p>
<p>This function takes as input a <code>GatingSet</code> data structure. This data structure can be constructed using the <a href="https://bioconductor.org/packages/release/bioc/html/flowWorkspace.html"><code>flowWorkspace</code></a> Bioconductor package. The gating set should contain all the experimental samples you wish to analyze using <code style="color:skyblue">faust</code>.</p>
<div id="documentation-" class="section level3">
<h3 class="hasAnchor">
<a href="#documentation-" class="anchor"></a>Documentation.</h3>
<div class="sourceCode" id="cb4"><html><body><pre class="r">?<span class="no">faust</span></pre></body></html></div>
<p>The documentation provides details about many <strong><span style="color:skyblue">faust</span></strong> parameters. The goal of this vignette is to give an overview of how you can use <strong><span style="color:skyblue">faust</span></strong> to analyze experimental data, using data from the FlowCAP III Lyoplate challenge as a case-study.</p>
</div>
</div>
<div id="faust-step-one-construct-a-gating-set-" class="section level2">
<h2 class="hasAnchor">
<a href="#faust-step-one-construct-a-gating-set-" class="anchor"></a>FAUST step one: construct a gating set.</h2>
<p>Run the following code block to install needed libraries, load the gating set, and also set the gating set path. The gating set path is passed to the FAUST pipeline.</p>
<div class="sourceCode" id="cb5"><html><body><pre class="r"><span class="co"># Get the gating set.</span>
<span class="fu"><a href="https://rdrr.io/pkg/flowWorkspaceData/man/flowWorkspaceDataInfo.html">flowWorkspaceDataInfo</a></span>()</pre></body></html></div>
<pre><code>#&gt; This package contains fcs data files, xml workspaces and GatingSets for testing the flowWorkspace and openCyto packages and building the their vignettes.
#&gt;  These can be located in the inst/extdata directory of the flowWorkspaceData package.
#&gt;  The sample files and workspaces contain data from whole blood. The primary purpose of this data set is to test the import code and export code in the flowWorkspace package and running automated gating pipeline in the openCyto package.</code></pre>
<div class="sourceCode" id="cb7"><html><body><pre class="r"><span class="no">gsPath</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/system.file.html">system.file</a></span>(<span class="st">"extdata"</span>,<span class="st">"gs_bcell_auto"</span>, <span class="kw">package</span> <span class="kw">=</span> <span class="st">"flowWorkspaceData"</span>)
<span class="no">gs</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/flowWorkspace/man/save_gs.html">load_gs</a></span>(<span class="no">gsPath</span>)

<span class="co"># Inspect the manual strategy.</span>
<span class="fu"><a href="https://rdrr.io/pkg/flowWorkspace/man/plot-methods.html">plot</a></span>(<span class="no">gs</span><span class="kw">[[</span><span class="fl">1</span>]],  <span class="kw">boolean</span> <span class="kw">=</span> <span class="fl">TRUE</span>)</pre></body></html></div>
<p><img src="faustIntro_files/figure-html/get_gatingset-1.png" width="600" style="display: block; margin: auto;"></p>
</div>
<div id="faust-step-two-specify-the-experimental-unit-of-anlaysis-" class="section level2">
<h2 class="hasAnchor">
<a href="#faust-step-two-specify-the-experimental-unit-of-anlaysis-" class="anchor"></a><code>FAUST</code> step two: specify the experimental unit of anlaysis.</h2>
<p>The first parameter the user may wish to set in order to use the <code>FAUST</code> method is called <code>experimentalUnit</code>. This parameter specifies how samples in the experiment should be combined in order for <code>FAUST</code> to perform discovery and annotation. In other words, this parameter defines the experimental unit of analysis. If the user does not wish to modify this parameter value, <code>FAUST</code> will use <strong>individual samples</strong> as the experimental unit of analysis.</p>
<p>The samples should usually be combined so that they represent relatively homogeneous collections of samples. What constitutes a homogeneous collection depends on the experimental context. As examples, data could not be combined at all and analyzed by individual sample; they could be grouped by subject, so that all samples from a subject are analyzed together; they could be grouped by batch so all samples in a batch are combined; or they could be combined by stimulation so that all samples under common stimulation are analyzed together; or they could be combined so all samples in the experiment are analyzed as a homogeneous group.</p>
<p>Here we run <code>FAUST</code> at the individual sample level (which is its default setting), so that cell population discovery and annotation is performed for each sample separately. The gating set data structure contains experimental metadata, accessed through the <code>pData</code> method. When applied to a gating set, <code><a href="https://rdrr.io/pkg/flowWorkspace/man/pData-methods.html">pData(gs)</a></code> returns a data frame of experimental metadata. The <code>FAUST</code> parameter <code>experimentalUnit</code> must be set to one of the column names in the <code><a href="https://rdrr.io/pkg/flowWorkspace/man/pData-methods.html">pData(gs)</a></code> data frame. <code>FAUST</code> will use this parameter to concatenate experimental samples prior to conducting discovery and annotation. To run <code>FAUST</code> at the sample level, we will set this parameter to “name”.</p>
</div>
<div id="faust-step-three-decide-on-the-starting-cell-population" class="section level2">
<h2 class="hasAnchor">
<a href="#faust-step-three-decide-on-the-starting-cell-population" class="anchor"></a><code>FAUST</code> step three: decide on the starting cell population</h2>
<p>A <code>gatingSet</code> will often have a manual gating strategy attached to it, that records how human investigators have interrogated the flow or mass cytometry samples. The <code>FAUST</code> pipeline benefits from using this gating information by selecting a starting cell population that has had debris and dead cells already gated out. If gating has not been provided, <a href="https://bioconductor.org/packages/release/bioc/html/openCyto.html"><code>openCyto</code></a> can be used to gate singlets and identify live cells.</p>
<p>We will use the “Live” node in the manual gating tree as our starting cell population for each sample.</p>
<div class="sourceCode" id="cb8"><html><body><pre class="r"><span class="no">startingNode</span> <span class="kw">&lt;-</span> <span class="st">"Live"</span></pre></body></html></div>
</div>
<div id="faust-step-four-decide-what-channels-to-use-" class="section level2">
<h2 class="hasAnchor">
<a href="#faust-step-four-decide-what-channels-to-use-" class="anchor"></a><code>FAUST</code> step four: decide what channels to use.</h2>
<p>The <code>GatingSet</code> records information about the <em>markers</em> used in a flow or mass cytometry experiment, as well as the expression level of those markers on each single cell recorded in the experiment. The <code>FAUST</code> pipeline assumes that a common set of markers is available for all samples in an experiment. We are not required to use <strong>all</strong> the available markers. The markers used should be passed to <code>FAUST</code> in a <code>character vector</code>. They must <strong>exactly</strong> match the <code>desc</code> field of the <code>parameters</code> of the <code>flowFrames</code> in the <code>GatingSet.</code>FAUST` will not run if they do not match exactly.</p>
<p>Here we are analyzing two samples from the manually gated Lyoplate B cell data set. This data set has a peculiarity, in that the <code>markers</code> and <code>channels</code> are swapped. We need to swap them back in order to get meaningful cell population phenotypes returned to us by <code>FAUST</code>. We do that below:</p>
<div class="sourceCode" id="cb9"><html><body><pre class="r"><span class="co">## The marker names have channel assignments</span>
<span class="fu"><a href="https://rdrr.io/pkg/flowWorkspace/man/markernames.html">markernames</a></span>(<span class="no">gs</span>)</pre></body></html></div>
<pre><code>#&gt;   Live    CD3   CD19   CD20    IgD   CD27   CD38   CD24 
#&gt; "Live"  "CD3" "CD19" "CD20"  "IgD" "CD27" "CD38" "CD24"</code></pre>
<div class="sourceCode" id="cb11"><html><body><pre class="r"><span class="co">## The column names are actually the channels.</span>
<span class="fu"><a href="https://rdrr.io/r/base/colnames.html">colnames</a></span>(<span class="no">gs</span>)</pre></body></html></div>
<pre><code>#&gt;  [1] "FSC-A" "SSC-A" "Live"  "CD3"   "CD19"  "CD20"  "IgD"   "CD27"  "CD38" 
#&gt; [10] "CD24"</code></pre>
<div class="sourceCode" id="cb13"><html><body><pre class="r"><span class="co">## We need to swap these</span>
<span class="no">newmarkers</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/colnames.html">colnames</a></span>(<span class="no">gs</span>)
<span class="fu"><a href="https://rdrr.io/r/base/names.html">names</a></span>(<span class="no">newmarkers</span>) <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/colnames.html">colnames</a></span>(<span class="no">gs</span>)
<span class="fu"><a href="https://rdrr.io/pkg/flowWorkspace/man/markernames.html">markernames</a></span>(<span class="no">gs</span>) <span class="kw">&lt;-</span> <span class="no">newmarkers</span>
<span class="fu"><a href="https://rdrr.io/pkg/flowWorkspace/man/markernames.html">markernames</a></span>(<span class="no">gs</span>)</pre></body></html></div>
<pre><code>#&gt;   Live    CD3   CD19   CD20    IgD   CD27   CD38   CD24 
#&gt; "Live"  "CD3" "CD19" "CD20"  "IgD" "CD27" "CD38" "CD24"</code></pre>
<div class="sourceCode" id="cb15"><html><body><pre class="r"><span class="co">## We don't need the live channel.</span>
<span class="no">activeChannelsIn</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/flowWorkspace/man/markernames.html">markernames</a></span>(<span class="no">gs</span>)[-<span class="fl">1L</span>]</pre></body></html></div>
</div>
<div id="faust-step-five-set-channel-bounds-" class="section level2">
<h2 class="hasAnchor">
<a href="#faust-step-five-set-channel-bounds-" class="anchor"></a><code>FAUST</code> step five: set channel bounds.</h2>
<p>The channel bounds encode prior knowledge about the channels in the experiment.</p>
<p>Our prior knowledge tells us about the expression level below which <code>FAUST</code> annotations should be treated as “Low” and above which <code>FAUST</code> annotations should be treated as “High”. For example, we would expect any cell populations with an median fluorescence intensity (MFI) below 0 in a channel to be annnotated as “Low” for that channel. Similarly, cell populatins with an MFI above, say 3500 (out of 4096 in FlowJo channel space) in a channel, we would annotate as “High” This is domain-specific knowledge, and <code>FAUST</code> allows us to encode this knowledge. We encode this in a <code>data.frame</code> with columns corresponding to <strong>channels</strong> and rows corresponding to the <strong>lower</strong> and <strong>upper</strong> bounds for “Low” and “High” annotations for each channel.</p>
<p>Expression values in a channel less than or equal to the value in the “Low” row are treated as low, by default, and not actively considered when <code>FAUST</code> processes the data. Expression values in a channel greater than or equal to the value in the “High” row are treated as high, by default, and not actively considered when <code>FAUST</code> processes the data.</p>
<p>If the user does not wish to set this parameter, <code>FAUST</code> will estimate values for each channel empirically: the 1st and 99th percentiles will be computed for each marker in each experimental unit, and the 5th and 95th percentiles across all experimental units will be used at the “Low” and “High” values for each respective marker.</p>
<p>Here we set the lower value to 0 and the upper value to 3500. These values are picked after inspecting the distribution of the data after compensation and transformation to a comparable scale.</p>
<div class="sourceCode" id="cb16"><html><body><pre class="r"><span class="no">channelBoundsIn</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html">matrix</a></span>(<span class="fl">0</span>,<span class="kw">nrow</span><span class="kw">=</span><span class="fl">2</span>,<span class="kw">ncol</span><span class="kw">=</span><span class="fu"><a href="https://rdrr.io/pkg/flowWorkspace/man/length.html">length</a></span>(<span class="no">activeChannelsIn</span>))
<span class="fu"><a href="https://rdrr.io/r/base/colnames.html">colnames</a></span>(<span class="no">channelBoundsIn</span>) <span class="kw">&lt;-</span> <span class="no">activeChannelsIn</span>
<span class="fu"><a href="https://rdrr.io/r/base/colnames.html">rownames</a></span>(<span class="no">channelBoundsIn</span>) <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="st">"Low"</span>,<span class="st">"High"</span>)
<span class="no">channelBoundsIn</span>[<span class="st">"High"</span>,] <span class="kw">&lt;-</span> <span class="fl">3500</span>
<span class="no">channelBoundsIn</span></pre></body></html></div>
<pre><code>#&gt;       CD3 CD19 CD20  IgD CD27 CD38 CD24
#&gt; Low     0    0    0    0    0    0    0
#&gt; High 3500 3500 3500 3500 3500 3500 3500</code></pre>
</div>
<div id="faust-step-six-set-project-path" class="section level2">
<h2 class="hasAnchor">
<a href="#faust-step-six-set-project-path" class="anchor"></a><code>FAUST</code> step six: set project path</h2>
<p>When you run the <code>FAUST</code> pipeline, it will create a directory called <code>faustData</code> on your computer, located at a path that you provide.</p>
<p>The <code>faustData</code> directory stores intermediate data used by the pipeline, plotting data produced by the pipeline, and the final count matrix.</p>
<p>Here we’ll work in a temporary directory.</p>
<div class="sourceCode" id="cb18"><html><body><pre class="r"><span class="no">projPath</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/file.path.html">file.path</a></span>(<span class="fu"><a href="https://rdrr.io/r/base/tempfile.html">tempdir</a></span>(),<span class="st">"FAUST"</span>)
<span class="fu"><a href="https://rdrr.io/r/base/files2.html">dir.create</a></span>(<span class="no">projPath</span>, <span class="kw">recursive</span> <span class="kw">=</span> <span class="fl">TRUE</span>)</pre></body></html></div>
</div>
<div id="faust-step-seven-run-faust-to-generate-channel-depth-scores-" class="section level2">
<h2 class="hasAnchor">
<a href="#faust-step-seven-run-faust-to-generate-channel-depth-scores-" class="anchor"></a><code>FAUST</code> step seven: run FAUST to generate channel depth scores.</h2>
<p>We’ve gathered all the information we need.</p>
<p>We have the set of active channels, the lower and upper limits for annotation, and we have a <code>GatingSet</code>, and a project path.</p>
<p>We now invoke <code style="color:skyblue">faust</code>, the main function of the package. Note that the parameter <code>annotationsApproved</code> is set to <code>FALSE</code>. This will cause <code style="color:skyblue">faust</code> to grow the annotation forest, produce summary plots in the directory <code>projectPath/faustData/plotData</code>, and then terminate. The next section will describe how to interpret these plots.</p>
<div class="sourceCode" id="cb19"><html><body><pre class="r"><span class="fu"><a href="../reference/faust.html">faust</a></span>(
  <span class="kw">gatingSet</span> <span class="kw">=</span> <span class="no">gs</span>,
  <span class="kw">experimentalUnit</span> <span class="kw">=</span> <span class="st">"name"</span>,
  <span class="kw">activeChannels</span> <span class="kw">=</span> <span class="no">activeChannelsIn</span>,
  <span class="kw">channelBounds</span> <span class="kw">=</span> <span class="no">channelBoundsIn</span>,
  <span class="kw">startingCellPop</span> <span class="kw">=</span> <span class="no">startingNode</span>,
  <span class="kw">projectPath</span> <span class="kw">=</span> <span class="no">projPath</span>,
  <span class="kw">depthScoreThreshold</span> <span class="kw">=</span> <span class="fl">0.05</span>,
  <span class="kw">selectionQuantile</span> <span class="kw">=</span> <span class="fl">1.0</span>,
  <span class="kw">debugFlag</span> <span class="kw">=</span> <span class="fl">FALSE</span>,
  <span class="co">#set this to the number of threads you want to use on your system</span>
  <span class="kw">threadNum</span> <span class="kw">=</span> <span class="kw pkg">parallel</span><span class="kw ns">::</span><span class="fu"><a href="https://rdrr.io/r/parallel/detectCores.html">detectCores</a></span>() / <span class="fl">2</span> - <span class="fl">1</span>,
  <span class="kw">nameOccuranceNum</span><span class="kw">=</span><span class="fl">1</span>,
  <span class="kw">seedValue</span> <span class="kw">=</span> <span class="fl">271828</span>,
  <span class="kw">annotationsApproved</span> <span class="kw">=</span> <span class="fl">FALSE</span> <span class="co"># set to false before we inspect the scores plots.</span>
)</pre></body></html></div>
<pre><code>#&gt; [1] "********************************************************"
#&gt; [1] "FAUST has selected a subset of the marker panel using"
#&gt; [1] "the depth score at the specified selection quantile."
#&gt; [1] "Annotation thresholds have been generated for all selected markers."
#&gt; [1] "Plots have been written to file in the directory /tmp/RtmpEHTmaN/FAUST/faustData/plotData"
#&gt; [1] ""
#&gt; [1] "Review these plots to ensure all desired markers have been selected."
#&gt; [1] "If too many/too few markers have been selected, modify the parameters"
#&gt; [1] "depthScoreThreshold and selectionQuantile."
#&gt; [1] ""
#&gt; [1] "Also review the annotation thresholds displayed on the sample-level histograms in/tmp/RtmpEHTmaN/FAUST/faustData/plotData"
#&gt; [1] "If you wish to modify the placement of the annotation thresholds,"
#&gt; [1] "change the parameters supervisedList."
#&gt; [1] ""
#&gt; [1] "Changing the Low/High values in the channelBounds matrix will also affect"
#&gt; [1] "the placement of annotation thresholds. It is the most effective way to directly modify"
#&gt; [1] "their placement. However, when you modify the Low/High values in the channelBounds matrix,"
#&gt; [1] "the FAUST method will regrow the entire annotation forest."
#&gt; [1] ""
#&gt; [1] "Once you are satisfied with the annotation boundary"
#&gt; [1] "placement, set the parameter"
#&gt; [1] "annotationsApproved=TRUE in the faust R function."
#&gt; [1] "FAUST will then conduct phenotype discovery and "
#&gt; [1] "annotation on each experimental unit."
#&gt; [1] "********************************************************"</code></pre>
<pre><code>#&gt; NULL</code></pre>
</div>
<div id="faust-step-eight-analyze-the-depth-score-line-plots-for-each-channel-" class="section level2">
<h2 class="hasAnchor">
<a href="#faust-step-eight-analyze-the-depth-score-line-plots-for-each-channel-" class="anchor"></a><code>FAUST</code> step eight: analyze the depth score line plots for each channel.</h2>
<p><code>FAUST</code> generates a preliminary <strong>annotation forest</strong> and we can examine the information in each <strong>channel</strong> before continuing. Some channels may not be very informative and so it may not be desirable to use those channels to annotate cell populations. <code>FAUST</code> computes a <strong>depth score</strong> that summarizes how informative a channel is.</p>
<div class="sourceCode" id="cb22"><html><body><pre class="r"><span class="no">path</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/file.path.html">file.path</a></span>(<span class="no">projPath</span>,<span class="st">"faustData"</span>,<span class="st">"plotData"</span>,<span class="st">"scoreLines.pdf"</span>)
<span class="fu"><a href="https://rdrr.io/r/base/cat.html">cat</a></span>(<span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span>(<span class="st">"&lt;img src='"</span>,<span class="no">path</span>,<span class="st">"'&gt;"</span>))</pre></body></html></div>
<p><img src="../../../../../tmp/RtmpEHTmaN/FAUST/faustData/plotData/scoreLines.pdf"></p>
</div>
<div id="faust-step-nine-run-the-annotations-with-the-revised-depth-score-thresholds-" class="section level2">
<h2 class="hasAnchor">
<a href="#faust-step-nine-run-the-annotations-with-the-revised-depth-score-thresholds-" class="anchor"></a><code>FAUST</code> step nine: run the annotations with the revised depth score thresholds.</h2>
<div class="sourceCode" id="cb23"><html><body><pre class="r"><span class="fu"><a href="../reference/faust.html">faust</a></span>(
  <span class="kw">gatingSet</span> <span class="kw">=</span> <span class="no">gs</span>,
  <span class="kw">experimentalUnit</span> <span class="kw">=</span> <span class="st">"name"</span>,
  <span class="kw">activeChannels</span> <span class="kw">=</span> <span class="no">activeChannelsIn</span>,
  <span class="kw">channelBounds</span> <span class="kw">=</span> <span class="no">channelBoundsIn</span>,
  <span class="kw">startingCellPop</span> <span class="kw">=</span> <span class="no">startingNode</span>,
  <span class="kw">projectPath</span> <span class="kw">=</span> <span class="no">projPath</span>,
  <span class="kw">depthScoreThreshold</span> <span class="kw">=</span> <span class="fl">0.05</span>,
  <span class="kw">selectionQuantile</span> <span class="kw">=</span> <span class="fl">1.0</span>,
  <span class="kw">debugFlag</span> <span class="kw">=</span> <span class="fl">FALSE</span>,
  <span class="co">#set this to the number of threads you want to use on your system</span>
  <span class="kw">threadNum</span> <span class="kw">=</span> <span class="kw pkg">parallel</span><span class="kw ns">::</span><span class="fu"><a href="https://rdrr.io/r/parallel/detectCores.html">detectCores</a></span>() / <span class="fl">2</span> - <span class="fl">1</span>,
  <span class="kw">nameOccuranceNum</span><span class="kw">=</span><span class="fl">1</span>,
  <span class="kw">seedValue</span> <span class="kw">=</span> <span class="fl">271828</span>,
  <span class="kw">annotationsApproved</span> <span class="kw">=</span> <span class="fl">TRUE</span>
)</pre></body></html></div>
</div>
<div id="faust-step-ten-analyze-the-results-" class="section level2">
<h2 class="hasAnchor">
<a href="#faust-step-ten-analyze-the-results-" class="anchor"></a><code>FAUST</code> step ten: analyze the results.</h2>
<p>The count matrix produced by the pipeline is written to file. We read it in.</p>
<div class="sourceCode" id="cb24"><html><body><pre class="r"><span class="no">countMatrix</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/readRDS.html">readRDS</a></span>(<span class="fu"><a href="https://rdrr.io/r/base/file.path.html">file.path</a></span>(<span class="no">projPath</span>,<span class="st">"faustData"</span>,<span class="st">"faustCountMatrix.rds"</span>))
<span class="co"># Make suitable for ggplot</span>
<span class="no">count.long</span> <span class="kw">&lt;-</span> <span class="no">countMatrix</span> <span class="kw">%&gt;%</span>
  <span class="no">as.data.frame</span> <span class="kw">%&gt;%</span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span>(<span class="kw">sample</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/colnames.html">rownames</a></span>(<span class="no">.</span>)) <span class="kw">%&gt;%</span>
  <span class="fu"><a href="https://tidyr.tidyverse.org/reference/gather.html">gather</a></span>(<span class="kw">key</span> <span class="kw">=</span> <span class="no">population</span>, <span class="kw">value</span> <span class="kw">=</span> <span class="no">count</span>,<span class="fl">1</span>:(<span class="fu"><a href="https://rdrr.io/r/base/nrow.html">ncol</a></span>(<span class="no">.</span>) - <span class="fl">1</span>) )

<span class="co"># Run clustering</span>
<span class="no">count.dendro</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/dendrogram.html">as.dendrogram</a></span>(<span class="fu"><a href="https://rdrr.io/r/stats/hclust.html">hclust</a></span>(<span class="kw">d</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/dist.html">dist</a></span>(<span class="kw">x</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/t.html">t</a></span>(<span class="no">countMatrix</span>))))

<span class="co"># Create dendrogram plot</span>
<span class="no">dendro.plot</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/ggdendro/man/ggdendrogram.html">ggdendrogram</a></span>(<span class="kw">data</span> <span class="kw">=</span> <span class="no">count.dendro</span>, <span class="kw">rotate</span> <span class="kw">=</span> <span class="fl">TRUE</span>) +
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme.html">theme</a></span>(<span class="kw">axis.text.y</span> <span class="kw">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html">element_text</a></span>(<span class="kw">size</span> <span class="kw">=</span> <span class="fl">6</span>))

<span class="co"># Extract the order</span>
<span class="no">count.order</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/order.dendrogram.html">order.dendrogram</a></span>(<span class="no">count.dendro</span>)

<span class="co"># Order the levels </span>
<span class="no">count.long</span>$<span class="no">population</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html">factor</a></span>(<span class="kw">x</span> <span class="kw">=</span> <span class="no">count.long</span>$<span class="no">population</span>,
                               <span class="kw">levels</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/colnames.html">rownames</a></span>(<span class="fu"><a href="https://rdrr.io/r/base/t.html">t</a></span>(<span class="no">countMatrix</span>))[<span class="no">count.order</span>],
                               <span class="kw">ordered</span> <span class="kw">=</span> <span class="fl">TRUE</span>)

<span class="co"># Create heatmap plot</span>
<span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span>(<span class="kw">data</span> <span class="kw">=</span> <span class="no">count.long</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span>(<span class="kw">x</span> <span class="kw">=</span> <span class="no">sample</span>, <span class="kw">y</span> <span class="kw">=</span> <span class="no">population</span>)) +
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_tile.html">geom_tile</a></span>(<span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span>(<span class="kw">fill</span> <span class="kw">=</span> <span class="no">count</span>)) +
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_brewer.html">scale_fill_distiller</a></span>(<span class="kw">trans</span> <span class="kw">=</span><span class="st">"log10"</span>, <span class="kw">palette</span> <span class="kw">=</span> <span class="fl">2</span>, <span class="kw">type</span> <span class="kw">=</span> <span class="st">"div"</span>) +
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme.html">theme</a></span>(<span class="kw">legend.position</span> <span class="kw">=</span> <span class="st">"top"</span>) +
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html">ggtitle</a></span>(<span class="st">"Cell counts of populations by samples"</span>) +
   <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme.html">theme</a></span>(<span class="kw">axis.text.x</span> <span class="kw">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html">element_text</a></span>(<span class="kw">angle</span> <span class="kw">=</span> <span class="fl">45</span>, <span class="kw">hjust</span> <span class="kw">=</span> <span class="fl">1</span>))</pre></body></html></div>
<p><img src="faustIntro_files/figure-html/read_count_matrix-1.png" width="600" style="display: block; margin: auto;"> The last column is the “not annotated” subset, which <strong><span style="color:skyblue">faust</span></strong> encodes as “0_0_0_0_0”.</p>
<p>Cells are given the generic label by <strong><span style="color:skyblue">faust</span></strong> in one of two ways. Each cell in each experimental unit is associated with a full annotation by <strong><span style="color:skyblue">faust</span></strong>. The number of times a phenotype occurs across the experimental units is counted by <strong><span style="color:skyblue">faust</span></strong>. If the resulting number falls below the setting of the <code>nameOccuranceNum</code> parameter in the <strong><span style="color:skyblue">faust</span></strong> function, all cells associated with that phenotype are labeled “0_0_0_0_0”. This is how <strong><span style="color:skyblue">faust</span></strong> implements phenotypic filtering as described by the manuscript.</p>
<p>All phenotypes that survive the phenotypic filtering step are then gated out sample-by-sample, relative to the annotation boundaries determined for their experimental unit. The second way a cell is labeled “0_0_0_0_0” occurs at this gating step: if the measured protein expression of a cell disagrees with the associated phenotype for any of the markers contained in the phenotypic label, the cell is then labeled “0_0_0_0_0”. This step guarantees that the annotations produced by <strong><span style="color:skyblue">faust</span></strong> are consistent with the underlying protein measurements.</p>
<p>We can generate pairwise dotplots showing the gating strategies to gate out discovered cell populations. Not all cell populations are meaningful (some are too small). We’ll prefilter and plot those that might have some meaningful support in the data.</p>
<div class="sourceCode" id="cb25"><html><body><pre class="r"><span class="no">pops</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/names.html">names</a></span>(<span class="fu"><a href="https://rdrr.io/r/base/which.html">which</a></span>(<span class="fu"><a href="https://rdrr.io/r/base/colSums.html">colSums</a></span>(<span class="no">countMatrix</span>) <span class="kw">&gt;</span> <span class="fl">1000</span>)) <span class="co"># at least 1000 cells across all samples</span>
<span class="no">pops</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/reexports.html">setdiff</a></span>(<span class="no">pops</span>,<span class="st">"0_0_0_0_0"</span>) <span class="co">#We don't want plots for the not-annotated cells.</span>
<span class="kw">for</span> (<span class="no">col</span> <span class="kw">in</span> <span class="no">pops</span>) {
  <span class="kw">for</span> (<span class="no">r</span> <span class="kw">in</span> <span class="fu"><a href="https://rdrr.io/r/base/colnames.html">rownames</a></span>(<span class="no">countMatrix</span>)) {
    <span class="kw pkg">faust</span><span class="kw ns">:::</span><span class="fu"><a href="../reference/plotFaustGates.html">plotFaustGates</a></span>(<span class="no">col</span>, <span class="no">r</span>, <span class="no">projPath</span>)
  }
}</pre></body></html></div>
<p>Plots are stored in the <code>projectPath/faustData/plotData</code> directory.</p>
</div>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="pkgdown-sidebar">

        <nav id="toc" data-toggle="toc"><h2 data-toc-skip>Contents</h2>
    </nav>
</div>

</div>



      <footer><div class="copyright">
  <p>Developed by Evan Greene.</p>
</div>

<div class="pkgdown">
  <p>Site built with <a href="https://pkgdown.r-lib.org/">pkgdown</a> 1.5.1.</p>
</div>

      </footer>
</div>

  


  </body>
</html>
